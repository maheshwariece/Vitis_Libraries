


<!DOCTYPE HTML>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		<meta content="Vitis Database Library, GQE, L3, Overlay" name="keywords" />
<meta content="Vitis Database Library L3 GQE host" name="description" />
<meta content="Document" name="xlnxdocumentclass" />
<meta content="Tutorials" name="xlnxdocumenttype" />

		<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
		<link rel="stylesheet" href="https://static.cloud.coveo.com/searchui/v2.4382/css/CoveoFullSearch.css"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta name="description"/>
		<meta name="keywords"/>
		<meta property="og:title" content=""/>
		<meta property="og:description"/>
		<!-- favicon -->
		<link rel="icon" type="image/vnd.microsoft.icon" href="../_static/favicon.ico"/>
		<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../_static/favicon.ico"/>
		<!-- Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet" type="text/css"/>

  
  
  
  

  
      <script type="text/javascript" src="../_static/js/jquery.min.js"></script>
	  <script type="text/javascript" src="../_static/js/gtm.js"></script>
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
    <script type="text/javascript" src="../_static/js/d3dd8c60ed.js"></script>
    <script type="text/javascript" src="../_static/js/common-ui-all.min.js"></script>
    <script type="text/javascript" src="../_static/js/header-footer.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../_static/js/CoveoJsSearch.Lazy.min.js"></script>
    <script type="text/javascript" src="../_static/js/linkid.js"></script>
    <script type="text/javascript" src="../_static/js/Searchbox.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/common-ui-all.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/header-footer.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/pro.min.css" media="all" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="GQE L3 APIs" href="gqe_l3_api.html" />
    <link rel="prev" title="L3 GQE Overlay User Guide" href="L3.html" /> 
	</head>
	<body>
		<div class="xilinx-bs3"/>
		<div class="root responsivegrid">
			<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 aem-Grid--large--16 aem-Grid--xlarge--16 aem-Grid--xxlarge--16 aem-Grid--xxxlarge--16 ">
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn aem-GridColumn--default--12">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="header parbase aem-GridColumn aem-GridColumn--default--12">
								<noindex>
									<header data-component="header">
										<nav class="navbar navbar-default aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid main-nav">
													<div class="row">
														<div class="col-xs-12">
															<div class="logo-column">
																<div class="logo">
																	<a href="https://www.xilinx.com/">
																	<img src="https://github.com/Xilinx/Image-Collateral/blob/main/xilinx-header-logo.svg?raw=true" title="Xilinx Inc"/>
																	</a>
																</div>
															</div>
															<div class="navbar-column">
																<div class="navbar navbar-collapse collapse" id="xilinx-main-menu">
																	<div class="mobile-search-container">
																		<div id="headerSearchBox" class="headerSearch"
																			data-component="header-search"
																			data-redirect-if-empty="false"
																			data-coveo-access-token="xxa237d4dd-f0aa-47fc-9baa-af9121851b33"
																			data-coveo-organization-id="xilinxcomprode2rjoqok">
																			<div class='coveo-search-section'>
																				<div class="CoveoAnalytics" data-search-hub="Site"></div>
																				<ul class="dropdown-menu options">
																					<li class="option" data-label="All" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-search-hub="Site">
																						<a href="#">
																						All</a>
																					</li>
																					<li data-label="Silicon Devices" data-action-link="https://www.xilinx.com//products/silicon-devices/si-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Silicon Devices</a>
																					</li>
																					<li data-label="Boards and Kits" data-action-link="https://www.xilinx.com//products/boards-and-kits/bk-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Boards and Kits</a>
																					</li>
																					<li data-label="Intellectual Property" data-action-link="https://www.xilinx.com//products/intellectual-property/ip-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Intellectual Property</a>
																					</li>
																					<li data-label="Support" class="option" data-action-link="https://www.xilinx.com/search/support-keyword-search.html" data-search-hub="Support">
																						<a href="#">
																						Support</a>
																						<ul>
																							<li data-label="Documentation" data-action-link="https://www.xilinx.com//support/documentation-navigation/documentation-keyword-search.html" data-search-hub="Document">
																								<a href="#">
																								Documentation</a>
																							</li>
																							<li data-label="Knowledge Base" data-action-link="https://www.xilinx.com//support/answer-navigation/answer-keyword-search.html" data-search-hub="AnswerRecord">
																								<a href="#">
																								Knowledge Base</a>
																							</li>
																							<li data-label="Community Forums" data-action-link="https://www.xilinx.com/search/forums-keyword-search.html" data-search-hub="Forums">
																								<a href="#">
																								Community Forums</a>
																							</li>
																						</ul>
																					</li>
																					<li data-label="Partners" data-action-link="https://www.xilinx.com//alliance/member-keyword-search.html" data-search-hub="Partner">
																						<a href="#">
																						Partners</a>
																					</li>
																					<li data-label="Videos" data-action-link="https://www.xilinx.com/video/video-keyword-search.html" data-search-hub="Video">
																						<a href="#">
																						Videos</a>
																					</li>
																					<li data-label="Press" data-action-link="https://www.xilinx.com/search/press-keyword-search.html" data-search-hub="Press">
																						<a href="#">
																						Press</a>
																					</li>
																				</ul>
																				<a href="#" class="btn dropdown-toggle value" data-toggle="dropdown"></a>
																				<div class="CoveoSearchbox" data-id="coveosearchbox" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-placeholder="Search Xilinx"></div>
																			</div>
																		</div>
																	</div>
																	<ul class="nav navbar-nav nav-justified">
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/applications.html">
																			Applications</a>
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/products/silicon-devices.html">
																			Products</a>
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://developer.xilinx.com/">
																			Developers</a>
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/support.html">
																			Support</a>
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/about/company-overview.html">
																			About</a>
																		</li>
																	</ul>
																</div>
															</div>
															<script type="text/javascript" src="../_static/js/gtm.js"></script>
															<!--<div class="mini-nav">
																<button type="button" data-function="xilinx-mobile-menu" id="nav-toggle" class="navbar-toggle collapsed visible-xs-block" aria-expanded="false">
																<span></span>
																<span></span>
																<span></span>
																<span></span>
																</button>
																<ul class="list-inline">
																	<li class="dropdown user-menu">
																		<button data-toggle="dropdown">
																		<span class="sr-only">Account</span>
																		<span class="fas fa-user"></span>
																		</button>
																		<ul class="dropdown-menu">
																			<li>
																				<a href="https://www.xilinx.com/myprofile/subscriptions.html">
																				My Account</a>
																			</li>
																			<li>
																				<a href="https://www.xilinx.com/registration/create-account.html">
																				Create Account</a>
																			</li>
																			<li>
																				<a href="https://www.xilinx.com/bin/protected/en/signout">
																				Sign Out</a>
																			</li>
																		</ul>
																	</li>
																	<li class="hidden-xs">
																		<button data-function="search-toggle">
																		<span class="sr-only">Search</span>
																		<span class="far fa-search"></span>
																		</button>
																	</li>
																</ul>
															</div>
															-->
															<div class="search-container">
																<div id="headerSearchBox" class="headerSearch"
																	data-component="header-search"
																	data-redirect-if-empty="false"
																	data-coveo-access-token="xxa237d4dd-f0aa-47fc-9baa-af9121851b33"
																	data-coveo-organization-id="xilinxcomprode2rjoqok">
																	<div class='coveo-search-section'>
																		<div class="CoveoAnalytics" data-search-hub="Site"></div>
																		<ul class="dropdown-menu options">
																			<li class="option" data-label="All" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-search-hub="Site">
																				<a href="#">
																				All</a>
																			</li>
																			<li data-label="Silicon Devices" data-action-link="https://www.xilinx.com/products/silicon-devices/si-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Silicon Devices</a>
																			</li>
																			<li data-label="Boards and Kits" data-action-link="https://www.xilinx.com/products/boards-and-kits/bk-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Boards and Kits</a>
																			</li>
																			<li data-label="Intellectual Property" data-action-link="https://www.xilinx.com/products/intellectual-property/ip-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Intellectual Property</a>
																			</li>
																			<li data-label="Support" class="option" data-action-link="https://www.xilinx.com/search/support-keyword-search.html" data-search-hub="Support">
																				<a href="#">
																				Support</a>
																				<ul>
																					<li data-label="Documentation" data-action-link="https://www.xilinx.com/support/documentation-navigation/documentation-keyword-search.html" data-search-hub="Document">
																						<a href="#">
																						Documentation</a>
																					</li>
																					<li data-label="Knowledge Base" data-action-link="https://www.xilinx.com/support/answer-navigation/answer-keyword-search.html" data-search-hub="AnswerRecord">
																						<a href="#">
																						Knowledge Base</a>
																					</li>
																					<li data-label="Community Forums" data-action-link="https://www.xilinx.com/search/forums-keyword-search.html" data-search-hub="Forums">
																						<a href="#">
																						Community Forums</a>
																					</li>
																				</ul>
																			</li>
																			<li data-label="Partners" data-action-link="https://www.xilinx.com/alliance/member-keyword-search.html" data-search-hub="Partner">
																				<a href="#">
																				Partners</a>
																			</li>
																			<li data-label="Videos" data-action-link="https://www.xilinx.com/video/video-keyword-search.html" data-search-hub="Video">
																				<a href="#">
																				Videos</a>
																			</li>
																			<li data-label="Press" data-action-link="https://www.xilinx.com/search/press-keyword-search.html" data-search-hub="Press">
																				<a href="#">
																				Press</a>
																			</li>
																		</ul>
																		<a href="#" class="btn dropdown-toggle value" data-toggle="dropdown"></a>
																		<div class="CoveoSearchbox" data-id="coveosearchbox" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-placeholder="Search Xilinx"></div>
																	</div>
																</div>
																<button data-function="search-toggle">
																<span class="sr-only">Search</span>
																<span class="far fa-times"></span>
																</button>
															</div>
														</div>
													</div>
												</div>
											</div>
										</nav>
									</header>
								</noindex>
							</div>
						</div>
					</div>
				</div>
				<div class="parsys aem-GridColumn--xxxlarge--none aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
						<div class="container-fluid">
							<div class="row">
							<div class="col-xs-12">
   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Vitis Database Library
          

          
          </a>

          
            
            
              <div class="version">
                2021.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

      
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
            
            
            
              
            
            
              <p class="caption"><span class="caption-text">Library Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Vitis Database Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release.html">Release Note</a></li>
<li class="toctree-l1"><a class="reference internal" href="../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_flows.html">Design Flows</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../guide/L1.html">L1 Module User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="L2.html">L2 GQE Kernel User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="L3.html">L3 GQE Overlay User Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">GQE L3 Design</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#joiner-design">Joiner Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bloom-filter-design">Bloom-Filter Design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#class-specifications">Class specifications</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-usage">Example Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#group-by-aggregate-design">Group-By Aggregate Design</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gqe_l3_api.html">GQE L3 APIs</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Benchmark Result</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../benchmark.html">Benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmark/tpc_h.html">TPC-H Queries with GQE</a></li>
</ul>

            
			
				<h3>Versions</h3>
				<ul>
				  <li><a href=""></a></li>
				  <li><a href=""></a></li>
				  <li><a href=""></a></li>
				  <li><a href=""></a></li>
				</ul>
			
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Vitis Database Library</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="L3.html">L3 GQE Overlay User Guide</a> &raquo;</li>
        
      <li>GQE L3 Design</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="gqe-l3-design">
<span id="id1"></span><h1>GQE L3 Design<a class="headerlink" href="#gqe-l3-design" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The GQE L3 APIs, which schedule the kernel execution, data transfers, and CPU data movement in pipeline, hides the detailed OpenCL calls, are provided for software programmers. Three categories of soft APIs are implemented, including join, bloom-filter, and group-by aggregate. Joiner and Bloomfilter are polished to supports 64-bit data input/output in this release. Aggegator kept 32-bit data input/output which is the same as the 2020.2 release.</p>
</div>
<div class="section" id="joiner-design">
<h2>Joiner Design<a class="headerlink" href="#joiner-design" title="Permalink to this headline">¶</a></h2>
<p>Join has two phases: build and probe. When the build table is fixed, the probe efficiency is linear to probe table size. However, when the build table gets larger, the performance of the probe decreases. In real scenarios, the size of both build and probe table is unknown. Therefore, to support different sized two tables’ join with efficient performance, two solutions are provided in L3:</p>
<ul class="simple">
<li>solution 0/1: Direct Join (1x Build + Nx Probe), which is used when the build table is not too large.</li>
<li>solution 2: Hash Partition + Hash Join, partitioning left table and right table to M partitions. Thereafter, Perform Build + Nx Probe  for each partition pair.</li>
</ul>
<p>In solution 1, the size of the build table is relatively small, so the probe phase is efficient. To minimize the overhead of data transfer and CPU data movement, the probe table is splitted into multi-section horizontally.</p>
<p>When the build table is large, partitioning the input tables into multi-partitions may keep the high-performance execution of build+probe. Solution 2 includes three sequential phases: Partitioning build table O, partitioning probe table L, and do multiple times of solution 1. For each phase, pipelined task scheduling is employed.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Comparing these two type of solutions, although partitioning table O and L introduces extra overhead of partitioning, the build+probe time is decreased due to the dramatically reduced unique key radio.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">With TPC-H Q5s query as the example, the solution 1 and 2 switching data size for build table is ~ SF8 (confirm?). Which is to say, when the scale factor is smaller than SF8, solution 1 is faster. For datasets larger than SF8, solution 2 would be faster.</p>
</div>
</div>
<div class="section" id="bloom-filter-design">
<h2>Bloom-Filter Design<a class="headerlink" href="#bloom-filter-design" title="Permalink to this headline">¶</a></h2>
<div class="section" id="class-specifications">
<h3>Class specifications<a class="headerlink" href="#class-specifications" title="Permalink to this headline">¶</a></h3>
<p>Generally, we provide 3 L3 classes for GQE Bloom-Filter to alleviate the software developers’ suffering for calling OpenCL APIs, arranging the column shuffles, splitting the table into sections with excutable size to accelerate database queries with the hardware kernels:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">gqe::FilterConfig</span></code>: for generating software shuffles for input and output columns plus the kernel configuration bits.</li>
<li><code class="docutils literal notranslate"><span class="pre">gqe::BloomFilter</span></code>: for calculating the bloom-filter size based on the number of unique keys, allocating buffers for internal hash-table, and performing software build and merge processes as we currently do not support build process for bloom-filtering.</li>
<li><code class="docutils literal notranslate"><span class="pre">gqe::Filter</span></code>: for performing the multi-threaded pipelined bloom-filtering.</li>
</ul>
</div>
<div class="section" id="example-usage">
<h3>Example Usage<a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h3>
<p id="bloomfilter-l3-usage">Since programming the FPGA is very time-consuming, we provide the hardware initialization and hardware run processes independently.</p>
<p>For initializing the hardware:</p>
<pre class="highlight literal-block">
<span></span><span class="c1">// Initializes FPGA</span>
<span class="n">gqe</span><span class="o">::</span><span class="n">FpgaInit</span> <span class="n">init_ocl</span><span class="p">(</span><span class="n">xclbin_path</span><span class="p">);</span>
<span class="c1">// Allocates pinned host buffers</span>
<span class="n">init_ocl</span><span class="p">.</span><span class="n">createHostBufs</span><span class="p">();</span>
<span class="c1">// Allocates device buffers</span>
<span class="n">init_ocl</span><span class="p">.</span><span class="n">createDevBufs</span><span class="p">();</span>
</pre>
<p>For loading the table columns and building the bloom-filter’s hash-table:</p>
<pre class="highlight literal-block">
<span></span><span class="c1">// Please first load data to corresponding table L column buffers</span>
<span class="c1">// We assume input table columns is stored in tab_l_col0 &amp; tab_l_col1,</span>
<span class="c1">// and the corresponding number of rows is stored in table_l_nrow</span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">BUILD_FACTOR</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">xf</span><span class="o">::</span><span class="n">database</span><span class="p">;</span>

<span class="c1">// Builds 0 - 1/BUILD_FACTOR of table L into bf1</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">table_l_nrow</span> <span class="o">/</span> <span class="n">BUILD_FACTOR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tab_o1_col0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tab_l_col0</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">tab_o1_col1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tab_l_col1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Builds 1/BUILD_FACTOR - 2/BUILD_FACTOR of table L into bf2</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">table_l_nrow</span> <span class="o">/</span> <span class="n">BUILD_FACTOR</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">table_l_nrow</span> <span class="o">/</span> <span class="n">BUILD_FACTOR</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tab_o2_col0</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">table_l_nrow</span> <span class="o">/</span> <span class="n">BUILD_FACTOR</span><span class="p">]</span> <span class="o">=</span> <span class="n">tab_l_col0</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">tab_o2_col1</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">table_l_nrow</span> <span class="o">/</span> <span class="n">BUILD_FACTOR</span><span class="p">]</span> <span class="o">=</span> <span class="n">tab_l_col1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Total number of unique keys at maximum</span>
<span class="kt">uint64_t</span> <span class="n">total_num_unique_keys</span> <span class="o">=</span> <span class="n">table_l_nrow</span> <span class="o">/</span> <span class="n">BUILD_FACTOR</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

<span class="c1">// Creates L table</span>
<span class="n">gqe</span><span class="o">::</span><span class="n">Table</span> <span class="n">tab_l</span><span class="p">(</span><span class="s">&quot;Table L&quot;</span><span class="p">);</span>
<span class="n">tab</span><span class="p">.</span><span class="n">addCol</span><span class="p">(</span><span class="s">&quot;l_orderkey&quot;</span><span class="p">,</span> <span class="n">gqe</span><span class="o">::</span><span class="n">TypeEnum</span><span class="o">::</span><span class="n">TypeInt64</span><span class="p">,</span> <span class="n">tab_l_col0</span><span class="p">,</span> <span class="n">table_l_nrow</span><span class="p">);</span>
<span class="n">tab</span><span class="p">.</span><span class="n">addCol</span><span class="p">(</span><span class="s">&quot;l_extendedprice&quot;</span><span class="p">,</span> <span class="n">gqe</span><span class="o">::</span><span class="n">TypeEnum</span><span class="o">::</span><span class="n">TypeInt64</span><span class="p">,</span> <span class="n">tab_l_col1</span><span class="p">,</span> <span class="n">table_l_nrow</span><span class="p">);</span>

<span class="c1">// Creates O1 table for building bloom-filter-1</span>
<span class="n">gqe</span><span class="o">::</span><span class="n">Table</span> <span class="n">tab_o1</span><span class="p">(</span><span class="s">&quot;Table O1&quot;</span><span class="p">);</span>
<span class="n">tab_o1</span><span class="p">.</span><span class="n">addCol</span><span class="p">(</span><span class="s">&quot;l_orderkey&quot;</span><span class="p">,</span> <span class="n">gqe</span><span class="o">::</span><span class="n">TypeEnum</span><span class="o">::</span><span class="n">TypeInt64</span><span class="p">,</span> <span class="n">tab_o1_col0</span><span class="p">,</span> <span class="n">table_l_nrow</span> <span class="o">/</span> <span class="n">BUILD_FACTOR</span><span class="p">);</span>
<span class="n">tab_o1</span><span class="p">.</span><span class="n">addCol</span><span class="p">(</span><span class="s">&quot;l_extendedprice&quot;</span><span class="p">,</span> <span class="n">gqe</span><span class="o">::</span><span class="n">TypeEnum</span><span class="o">::</span><span class="n">TypeInt64</span><span class="p">,</span> <span class="n">tab_o1_col1</span><span class="p">,</span> <span class="n">table_l_nrow</span><span class="o">/</span> <span class="n">BUILD_FACTOR</span><span class="p">);</span>

<span class="c1">// Builds bloom-filter-1</span>
<span class="n">gqe</span><span class="o">::</span><span class="n">BloomFilter</span> <span class="n">bf1</span><span class="p">(</span><span class="n">total_num_unique_keys</span><span class="p">);</span>
<span class="n">bf1</span><span class="p">.</span><span class="n">build</span><span class="p">(</span><span class="n">tbl_o1</span><span class="p">,</span> <span class="s">&quot;l_orderkey&quot;</span><span class="p">);</span>

<span class="c1">// Creates C table for stroing filtered results, at worst, we&#39;ll get every input key passes through the bloom-filter,</span>
<span class="c1">// so the size of the table c should be the same with table L</span>
<span class="n">gqe</span><span class="o">::</span><span class="n">Table</span> <span class="n">tab_c</span><span class="p">(</span><span class="s">&quot;Table C&quot;</span><span class="p">);</span>
<span class="n">tab_c</span><span class="p">.</span><span class="n">addCol</span><span class="p">(</span><span class="s">&quot;c1&quot;</span><span class="p">,</span> <span class="n">gqe</span><span class="o">::</span><span class="n">TypeEnum</span><span class="o">::</span><span class="n">TypeInt64</span><span class="p">,</span> <span class="n">tab_c_col0</span><span class="p">,</span> <span class="n">table_l_nrow</span><span class="p">);</span>
<span class="n">tab_c</span><span class="p">.</span><span class="n">addCol</span><span class="p">(</span><span class="s">&quot;c2&quot;</span><span class="p">,</span> <span class="n">gqe</span><span class="o">::</span><span class="n">TypeEnum</span><span class="o">::</span><span class="n">TypeInt64</span><span class="p">,</span> <span class="n">tab_c_col0</span><span class="p">,</span> <span class="n">table_l_nrow</span><span class="p">);</span>
</pre>
<p>Some use cases may need to merge several bloom-filters before running the filtering process:</p>
<pre class="highlight literal-block">
<span></span><span class="c1">// Creates O2 table for building bloom-filter-2</span>
<span class="n">gqe</span><span class="o">::</span><span class="n">Table</span> <span class="n">tab_o2</span><span class="p">(</span><span class="s">&quot;Table O2&quot;</span><span class="p">);</span>
<span class="n">tab_o2</span><span class="p">.</span><span class="n">addCol</span><span class="p">(</span><span class="s">&quot;l_orderkey&quot;</span><span class="p">,</span> <span class="n">gqe</span><span class="o">::</span><span class="n">TypeEnum</span><span class="o">::</span><span class="n">TypeInt64</span><span class="p">,</span> <span class="n">tab_o2_col0</span><span class="p">,</span> <span class="n">table_l_nrow</span> <span class="o">/</span> <span class="n">BUILD_FACTOR</span><span class="p">);</span>
<span class="n">tab_o2</span><span class="p">.</span><span class="n">addCol</span><span class="p">(</span><span class="s">&quot;l_extendedprice&quot;</span><span class="p">,</span> <span class="n">gqe</span><span class="o">::</span><span class="n">TypeEnum</span><span class="o">::</span><span class="n">TypeInt64</span><span class="p">,</span> <span class="n">tab_o2_col1</span><span class="p">,</span> <span class="n">table_l_nrow</span><span class="o">/</span> <span class="n">BUILD_FACTOR</span><span class="p">);</span>

<span class="c1">// Builds bloom-filter-2</span>
<span class="n">gqe</span><span class="o">::</span><span class="n">BloomFilter</span>  <span class="n">bf2</span><span class="p">(</span><span class="n">total_num_unique_keys</span><span class="p">);</span>
<span class="n">bf2</span><span class="p">.</span><span class="n">build</span><span class="p">(</span><span class="n">tab_o2</span><span class="p">,</span> <span class="s">&quot;l_orderkey&quot;</span><span class="p">);</span>

<span class="c1">// Merges bloom-filter-2 into bloom-filter-1</span>
<span class="n">bf1</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">bf2</span><span class="p">);</span>
</pre>
<p>At last, call the <code class="docutils literal notranslate"><span class="pre">run</span></code> API of <code class="docutils literal notranslate"><span class="pre">gqe::Filter</span></code> to perform the pipelined bloom-filtering:</p>
<pre class="highlight literal-block">
<span></span><span class="c1">// Creates bloom-filter engine</span>
<span class="n">gqe</span><span class="o">::</span><span class="n">Filter</span> <span class="n">bigfilter</span><span class="p">(</span><span class="n">init_ocl</span><span class="p">);</span>
<span class="c1">// Creates StrategySet object to pass on the number of sections of the table</span>
<span class="n">gqe</span><span class="o">::</span><span class="n">StrategySet</span> <span class="n">params</span><span class="p">;</span>
<span class="c1">// if set to 0, the section info should be provided in table L</span>
<span class="c1">// if set to n (n &gt; 0), the table L should be divided into n sections evenly</span>
<span class="n">params</span><span class="p">.</span><span class="n">sec_l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">gqe</span><span class="o">::</span><span class="n">ErrCode</span> <span class="n">err_code</span><span class="p">;</span>
<span class="c1">// Performs the bloom-filtering</span>
<span class="n">err_code</span> <span class="o">=</span> <span class="n">bigfilter</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">tab_l</span> <span class="c1">// input talbe</span>
                         <span class="s">&quot;l_orderkey&quot;</span><span class="p">,</span> <span class="c1">// selects key from input table</span>
                         <span class="n">bf1</span><span class="p">,</span> <span class="c1">// bloom-filter which provides hash-table</span>
                         <span class="s">&quot;&quot;</span><span class="p">,</span>  <span class="c1">// dynamic filter condition, empty for all passes through</span>
                         <span class="n">tab_c</span><span class="p">,</span> <span class="c1">// output table</span>
                         <span class="s">&quot;c1=l_extendedprice, c2=l_orderkey&quot;</span><span class="p">,</span> <span class="c1">// output mapping</span>
                         <span class="n">params</span><span class="p">);</span> <span class="c1">// Parameter strcut to provide section info</span>
</pre>
</div>
</div>
<div class="section" id="group-by-aggregate-design">
<h2>Group-By Aggregate Design<a class="headerlink" href="#group-by-aggregate-design" title="Permalink to this headline">¶</a></h2>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">No updates from Aggregate kernel and L3 Aggregate API. The 2020.2 released gqePart-32bit + gqeAggr-32bit kernel are employed here.</p>
</div>
<p>In L3 Aggregation, all solutions are listed below:</p>
<ol class="arabic simple">
<li>solution 0: Hash Aggregate, only for testing small datasets.</li>
<li>solution 1: Horizontally Cut + Pipelined Hash Aggregation</li>
<li>solution 2: Hash Partition + Pipelined Hash aggregation</li>
</ol>
<p>In solution 1, the first input table is horizontally cut into many slices, then do aggregation for each slice, finally merge results.
In solution 2, the first input table is hash partitioned into many hash partitions, then do aggregation for each partition (no merge in last).
Comparing the two solutions, solution 1 introduces extra overhead for CPU merging, while solution 2 added one more kernel(hash partition) execution time.
In summary, when input table has a high unique-ratio, solution 2 will be more beneficial than solution 1.
After profiling performance using inputs with different unique key ratios, we get the turning point.</p>
<a class="reference internal image-reference" href="../_images/L3_aggr_strategy.png"><img alt="Performance for different L3 strategies" class="align-center" src="../_images/L3_aggr_strategy.png" style="width: 521.6px; height: 314.40000000000003px;" /></a>
<p>In this figure, it shows when the unique key number is more than <cite>180K~240K</cite>, we can switch from <cite>solution 2</cite> to <cite>solution 3</cite>.</p>
<p>Others:
1) Hash Partition only support max 2 keys, when grouping by more keys, use <cite>solution 2</cite>
2) In solution 1, make one slice scale close to TPC-H SF1.
3) In solution 2, make one partition scale close to TPC-H SF1.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
<!-- Atalwar: Moved the footer code to layout.html to resolve conflict with the Xilinx template -->
</footer>

        </div>
      </div>


	  <!-- Sphinx Page Footer block -->
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="gqe_l3_api.html" class="btn btn-neutral float-right" title="GQE L3 APIs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="L3.html" class="btn btn-neutral float-left" title="L3 GQE Overlay User Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo" class="copyright">
    <p class="footerinfo">
      <span class="lastupdated">
        Last updated on June 09, 2021.
      </span>

    </p>
	<br>
  </div>
      </div>
    </section>


  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

   <script type="text/javascript">
    jQuery(function() { Search.loadIndex("searchindex.js"); });
  </script>

  <script type="text/javascript" id="searchindexloader"></script>


  
  
    
  



  <!--  Xilinx template footer block -->
							</div>
						</div>
					</div>
				</div>
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="footer parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
								<noindex>
                  <!-- make footer fixed - NileshP -->
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
                  <!-- make footer fixed NileshP-->
									<footer>
										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">
													<div class="row">
														<div class="footerSocial parbase">
															<div class="col-md-push-6 col-lg-push-6 col-md-6 col-lg-6">
																<ul class="list-inline pull-right social-menu">
																	<li>
																		<a href="https://www.linkedin.com/company/xilinx">
																		<span class="linkedin icon"></span>
																		<span class="sr-only">Connect on LinkedIn</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.twitter.com/XilinxInc">
																		<span class="twitter icon"></span>
																		<span class="sr-only">Follow us on Twitter</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.facebook.com/XilinxInc">
																		<span class="facebook icon"></span>
																		<span class="sr-only">Connect on Facebook</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.youtube.com/XilinxInc">
																		<span class="youtube icon"></span>
																		<span class="sr-only">Watch us on YouTube</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.xilinx.com/registration/subscriber-signup.html">
																		<span class="newsletter icon"></span>
																		<span class="sr-only">Subscribe to Newsletter</span>
																		</a>
																	</li>
																</ul>
															</div>
														</div>
														<div class="col-md-pull-6 col-lg-pull-6 col-md-6 col-lg-6">
															<span class="copyright">
                                  
                                  &copy; 2021, Xilinx
                              </span>
															<ul class="list-inline sub-menu">
																<li>
																	<a href="https://www.xilinx.com/about/privacy-policy.html">Privacy</a>
																</li>
																<li>
																	<a href="https://www.xilinx.com/about/legal.html">Legal</a>
																</li>
																<li>
																	<a href="https://www.xilinx.com/about/contact.html">Contact</a>
																</li>
															</ul>
														</div>
													</div>
												</div>
											</div>
										</div>
									</footer>
								</noindex>
							</div>
						</div>
					</div>
				</div>
				<div class="quicklinks parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<noindex>
						<span class="quickLinks">
							<ul>
								<li>
									<a href="#top" class="btn backToTop">
									<span class="fas fa-angle-up" aria-hidden="true"></span>
									</a>
								</li>
							</ul>
						</span>
					</noindex>
				</div>
			</div>
		</div>
		<script>window.CQ = window.CQ || {}</script>
		<script src="https://static.cloud.coveo.com/searchui/v2.4382/js/CoveoJsSearch.Lazy.min.js"></script>
		<script>
			var underscoreSetup = function () {
			  _.templateSettings.interpolate = /\{\{=([^-][\S\s]+?)\}\}/g;
			  _.templateSettings.evaluate = /\{\{([^-=][\S\s]+?)\}\}/g;
			  _.templateSettings.escape = /\{\{-([^=][\S\s]+?)\}\}/g;
			}

			underscoreSetup();
		</script>
	</body>
</html>